/// <reference path="./.sst/platform/config.d.ts" />

/**
 * Next.js + OpenNext + Notion CMS
 * SST Configuration with GitHub OIDC
 *
 * Stages:
 * - github-oidc: GitHub ActionsÁî®IAM„É≠„Éº„É´ÔºàÂàùÂõû„ÅÆ„ÅøÔºâ
 * - dev/stg/prod: „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥Áí∞Â¢É
 */

export default $config({
  app(input) {
    return {
      name: "magazine-cms",
      removal: input?.stage === "prod" ? "retain" : "remove",
      protect: ["prod"].includes(input?.stage),
      home: "aws",
    };
  },
  async run() {
    // ========================================
    // GitHub OIDCÂü∫Áõ§„Çπ„ÉÜ„Éº„Ç∏
    // ========================================
    if ($app.stage === "github-oidc") {
      return await deployGitHubOIDC();
    }

    // ========================================
    // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„Çπ„ÉÜ„Éº„Ç∏Ôºàdev/stg/prodÔºâ
    // ========================================
    return await deployApplication();
  },
});

// ========================================
// GitHub OIDCÂü∫Áõ§„Éá„Éó„É≠„Ç§Èñ¢Êï∞
// ========================================
async function deployGitHubOIDC() {
  const accountId = aws.getCallerIdentityOutput().accountId;
  const region = aws.getRegionOutput().name;

  // Êó¢Â≠òOIDC ProviderÁ¢∫Ë™ç
  const existingProviders = await aws.iam.getOpenIdConnectProviders({});
  const githubProviderArn = existingProviders.arns?.find(arn =>
    arn.includes("token.actions.githubusercontent.com")
  );

  let oidcProvider: aws.iam.OpenIdConnectProvider;

  if (githubProviderArn) {
    // Êó¢Â≠ò„ÇíÂèÇÁÖß
    console.log("Using existing GitHub OIDC Provider:", githubProviderArn);
    oidcProvider = aws.iam.OpenIdConnectProvider.get(
      "GitHubOIDC",
      githubProviderArn
    );
  } else {
    // Êñ∞Ë¶è‰ΩúÊàê
    console.log("Creating new GitHub OIDC Provider");
    oidcProvider = new aws.iam.OpenIdConnectProvider("GitHubOIDC", {
      url: "https://token.actions.githubusercontent.com",
      clientIdLists: ["sts.amazonaws.com"],
      thumbprintLists: [
        "6938fd4d98bab03faadb97b34396831e3780aea1",
        "1c58a3a8518e8759bf075b76b750d4f2df264fcd",
      ],
      tags: {
        ManagedBy: "SST",
        Purpose: "GitHub Actions OIDC",
      },
    });
  }

  // SSTÁâπÊúâ„ÅÆÊ®©Èôê„ÇíÂê´„ÇÄ„Éù„É™„Ç∑„Éº
  const sstDeployPolicy = new aws.iam.Policy("SSTDeployPolicy", {
    name: "magazine-cms-sst-deploy-policy",
    description: "Minimal permissions for SST deployment with lessons learned",
    policy: JSON.stringify({
      Version: "2012-10-17",
      Statement: [
        // CloudFormation
        {
          Sid: "CloudFormationAccess",
          Effect: "Allow",
          Action: [
            "cloudformation:CreateStack",
            "cloudformation:UpdateStack",
            "cloudformation:DeleteStack",
            "cloudformation:DescribeStacks",
            "cloudformation:DescribeStackEvents",
            "cloudformation:DescribeStackResources",
            "cloudformation:GetTemplate",
            "cloudformation:ValidateTemplate",
            "cloudformation:CreateChangeSet",
            "cloudformation:DescribeChangeSet",
            "cloudformation:ExecuteChangeSet",
            "cloudformation:DeleteChangeSet",
            "cloudformation:ListStacks",
          ],
          Resource: "*",
        },
        // S3: „Ç¢„Éó„É™„Éê„Ç±„ÉÉ„Éà + SST„Éê„Ç±„ÉÉ„Éà
        {
          Sid: "S3Access",
          Effect: "Allow",
          Action: [
            "s3:CreateBucket",
            "s3:DeleteBucket",
            "s3:ListBucket",
            "s3:GetBucketLocation",
            "s3:GetBucketPolicy",
            "s3:PutBucketPolicy",
            "s3:DeleteBucketPolicy",
            "s3:PutBucketWebsite",
            "s3:PutBucketVersioning",
            "s3:PutBucketCORS",
            "s3:PutObject",
            "s3:GetObject",
            "s3:DeleteObject",
            "s3:PutBucketPublicAccessBlock",
            "s3:PutLifecycleConfiguration",
            "s3:PutObjectTagging", // üí° ÈáçË¶Å: SST deploy„ÅßÂøÖË¶Å
            "s3:GetObjectTagging",
            "s3:DeleteObjectTagging",
          ],
          Resource: [
            "arn:aws:s3:::magazine-cms-*",
            "arn:aws:s3:::magazine-cms-*/*",
            "arn:aws:s3:::sst-*", // üí° SST„ÅÆÁä∂ÊÖãÁÆ°ÁêÜ„Éê„Ç±„ÉÉ„Éà
            "arn:aws:s3:::sst-*/*",
          ],
        },
        // CloudFront
        {
          Sid: "CloudFrontAccess",
          Effect: "Allow",
          Action: [
            "cloudfront:CreateDistribution",
            "cloudfront:UpdateDistribution",
            "cloudfront:DeleteDistribution",
            "cloudfront:GetDistribution",
            "cloudfront:GetDistributionConfig",
            "cloudfront:ListDistributions",
            "cloudfront:TagResource",
            "cloudfront:UntagResource",
            "cloudfront:CreateInvalidation",
            "cloudfront:GetInvalidation",
            "cloudfront:CreateOriginAccessControl",
            "cloudfront:GetOriginAccessControl",
            "cloudfront:UpdateOriginAccessControl",
            "cloudfront:DeleteOriginAccessControl",
            "cloudfront:CreateFunction",
            "cloudfront:UpdateFunction",
            "cloudfront:DeleteFunction",
            "cloudfront:PublishFunction",
          ],
          Resource: "*",
        },
        // Lambda
        {
          Sid: "LambdaAccess",
          Effect: "Allow",
          Action: [
            "lambda:CreateFunction",
            "lambda:UpdateFunctionCode",
            "lambda:UpdateFunctionConfiguration",
            "lambda:DeleteFunction",
            "lambda:GetFunction",
            "lambda:GetFunctionConfiguration",
            "lambda:GetFunctionCodeSigningConfig", // üí° ÈáçË¶Å: SST deploy„ÅßÂøÖË¶Å
            "lambda:PublishVersion",
            "lambda:ListVersionsByFunction",
            "lambda:CreateAlias",
            "lambda:UpdateAlias",
            "lambda:DeleteAlias",
            "lambda:GetAlias",
            "lambda:InvokeFunction",
            "lambda:AddPermission",
            "lambda:RemovePermission",
            "lambda:TagResource",
            "lambda:UntagResource",
            "lambda:PutFunctionConcurrency",
            "lambda:DeleteFunctionConcurrency",
          ],
          Resource: `arn:aws:lambda:*:${accountId}:function:magazine-cms-*`,
        },
        // IAM: LambdaÂÆüË°å„É≠„Éº„É´
        {
          Sid: "IAMRoleAccess",
          Effect: "Allow",
          Action: [
            "iam:CreateRole",
            "iam:DeleteRole",
            "iam:GetRole",
            "iam:PassRole",
            "iam:AttachRolePolicy",
            "iam:DetachRolePolicy",
            "iam:PutRolePolicy",
            "iam:DeleteRolePolicy",
            "iam:GetRolePolicy",
            "iam:TagRole",
            "iam:UntagRole",
            "iam:UpdateAssumeRolePolicy",
          ],
          Resource: `arn:aws:iam::${accountId}:role/magazine-cms-*`,
        },
        // SSM: SSTÁä∂ÊÖãÁÆ°ÁêÜ
        {
          Sid: "SSMParameterAccess",
          Effect: "Allow",
          Action: [
            "ssm:GetParameter",
            "ssm:GetParameters",
            "ssm:PutParameter",
            "ssm:DeleteParameter",
            "ssm:AddTagsToResource",
            "ssm:RemoveTagsFromResource",
          ],
          Resource: `arn:aws:ssm:*:${accountId}:parameter/sst/*`, // üí° /sst/* ÂÖ®‰Ωì
        },
        // VPCÈñ¢ÈÄ£ÔºàNext.jsÁî®Ôºâ
        {
          Sid: "VPCAccess",
          Effect: "Allow",
          Action: [
            "ec2:CreateVpc",
            "ec2:DeleteVpc",
            "ec2:DescribeVpcs",
            "ec2:ModifyVpcAttribute",
            "ec2:CreateSubnet",
            "ec2:DeleteSubnet",
            "ec2:DescribeSubnets",
            "ec2:CreateRouteTable",
            "ec2:DeleteRouteTable",
            "ec2:DescribeRouteTables",
            "ec2:CreateRoute",
            "ec2:DeleteRoute",
            "ec2:AssociateRouteTable",
            "ec2:DisassociateRouteTable",
            "ec2:CreateInternetGateway",
            "ec2:AttachInternetGateway",
            "ec2:DetachInternetGateway",
            "ec2:DeleteInternetGateway",
            "ec2:DescribeInternetGateways",
            "ec2:CreateNatGateway",
            "ec2:DeleteNatGateway",
            "ec2:DescribeNatGateways",
            "ec2:AllocateAddress",
            "ec2:ReleaseAddress",
            "ec2:DescribeAddresses",
            "ec2:CreateSecurityGroup",
            "ec2:DeleteSecurityGroup",
            "ec2:DescribeSecurityGroups",
            "ec2:AuthorizeSecurityGroupIngress",
            "ec2:AuthorizeSecurityGroupEgress",
            "ec2:RevokeSecurityGroupIngress",
            "ec2:RevokeSecurityGroupEgress",
            "ec2:CreateVpcEndpoint",
            "ec2:DeleteVpcEndpoint",
            "ec2:DescribeVpcEndpoints",
            "ec2:ModifyVpcEndpoint",
            "ec2:CreateTags",
            "ec2:DescribeTags",
          ],
          Resource: "*",
        },
        // WAF
        {
          Sid: "WAFAccess",
          Effect: "Allow",
          Action: [
            "wafv2:CreateWebACL",
            "wafv2:UpdateWebACL",
            "wafv2:DeleteWebACL",
            "wafv2:GetWebACL",
            "wafv2:ListWebACLs",
            "wafv2:AssociateWebACL",
            "wafv2:DisassociateWebACL",
            "wafv2:TagResource",
            "wafv2:UntagResource",
          ],
          Resource: "*",
        },
        // Route53Ôºà„Ç´„Çπ„Çø„É†„Éâ„É°„Ç§„É≥‰ΩøÁî®ÊôÇÔºâ
        {
          Sid: "Route53Access",
          Effect: "Allow",
          Action: [
            "route53:ListHostedZones",
            "route53:GetHostedZone",
            "route53:ChangeResourceRecordSets",
            "route53:GetChange",
            "route53:ListResourceRecordSets",
          ],
          Resource: "*",
        },
        // ACMÔºàSSLË®ºÊòéÊõ∏Ôºâ
        {
          Sid: "ACMAccess",
          Effect: "Allow",
          Action: [
            "acm:ListCertificates",
            "acm:DescribeCertificate",
            "acm:RequestCertificate",
            "acm:DeleteCertificate",
            "acm:AddTagsToCertificate",
          ],
          Resource: "*",
        },
        // CloudWatch Logs
        {
          Sid: "LogsAccess",
          Effect: "Allow",
          Action: [
            "logs:CreateLogGroup",
            "logs:DeleteLogGroup",
            "logs:DescribeLogGroups",
            "logs:PutRetentionPolicy",
            "logs:TagLogGroup",
            "logs:UntagLogGroup",
          ],
          Resource: `arn:aws:logs:*:${accountId}:log-group:/aws/lambda/magazine-cms-*`,
        },
        // Secrets ManagerÔºàÂøÖË¶Å„Å´Âøú„Åò„Å¶Ôºâ
        {
          Sid: "SecretsAccess",
          Effect: "Allow",
          Action: [
            "secretsmanager:GetSecretValue",
            "secretsmanager:DescribeSecret",
          ],
          Resource: `arn:aws:secretsmanager:*:${accountId}:secret:magazine-cms/*`,
        },
        // „Åù„ÅÆ‰ªñ
        {
          Sid: "AdditionalServices",
          Effect: "Allow",
          Action: [
            "sts:GetCallerIdentity",
          ],
          Resource: "*",
        },
      ],
    }),
    tags: {
      ManagedBy: "SST",
      Stage: "github-oidc",
    },
  });

  // GitHub ActionsÁî®IAM„É≠„Éº„É´
  const githubRole = new aws.iam.Role("GitHubActionsRole", {
    name: "magazine-cms-github-actions-role",
    assumeRolePolicy: oidcProvider.arn.apply(providerArn =>
      JSON.stringify({
        Version: "2012-10-17",
        Statement: [
          {
            Effect: "Allow",
            Principal: {
              Federated: providerArn,
            },
            Action: "sts:AssumeRoleWithWebIdentity",
            Condition: {
              StringEquals: {
                "token.actions.githubusercontent.com:aud": "sts.amazonaws.com",
              },
              StringLike: {
                "token.actions.githubusercontent.com:sub": [
                  "repo:yourorg/magazine-cms:ref:refs/heads/main",
                  "repo:yourorg/magazine-cms:ref:refs/heads/develop",
                  "repo:yourorg/magazine-cms:ref:refs/heads/release/*",
                ],
              },
            },
          },
        ],
      })
    ),
    managedPolicyArns: [sstDeployPolicy.arn],
    tags: {
      Purpose: "GitHub Actions OIDC",
      ManagedBy: "SST",
      Stage: "github-oidc",
    },
  });

  // Âá∫Âäõ
  return {
    oidcProviderArn: oidcProvider.arn,
    roleArn: githubRole.arn,
    roleName: githubRole.name,
    accountId: accountId,
    region: region,
  };
}

// ========================================
// „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„Éá„Éó„É≠„Ç§Èñ¢Êï∞
// ========================================
async function deployApplication() {
  const accountId = aws.getCallerIdentityOutput().accountId;

  // ========================================
  // VPCÊßãÁØâ
  // ========================================
  const vpc = new sst.aws.Vpc("AppVpc", {
    // Prod„ÅØ„Éû„É´„ÉÅaz„ÄÅDev/Stg„ÅØ„Ç∑„É≥„Ç∞„É´„Åß„Ç≥„Çπ„ÉàÂâäÊ∏õ
    nat: $app.stage === "prod" ? "managed" : "ec2",
    az: $app.stage === "prod" ? 2 : 1,
  });

  // VPC Endpoint: S3ÔºàGatewayÂûã„ÄÅÁÑ°ÊñôÔºâ
  const s3Endpoint = new aws.ec2.VpcEndpoint("S3Endpoint", {
    vpcId: vpc.id,
    serviceName: `com.amazonaws.${aws.getRegionOutput().name}.s3`,
    vpcEndpointType: "Gateway",
    routeTableIds: vpc.privateSubnets.apply(subnets =>
      // Route table„ÇíÂèñÂæó„Åô„ÇãÂøÖË¶Å„ÅÇ„ÇäÔºàÂÆüË£ÖÊôÇ„Å´Ë™øÊï¥Ôºâ
      []
    ),
    tags: {
      Name: `magazine-cms-${$app.stage}-s3-endpoint`,
      Environment: $app.stage,
      ManagedBy: "SST",
    },
  });

  // LambdaÁî®„Çª„Ç≠„É•„É™„ÉÜ„Ç£„Ç∞„É´„Éº„Éó
  const lambdaSg = new aws.ec2.SecurityGroup("LambdaSg", {
    vpcId: vpc.id,
    description: "Security group for Lambda functions",
    egress: [
      {
        protocol: "-1",
        fromPort: 0,
        toPort: 0,
        cidrBlocks: ["0.0.0.0/0"],
        description: "Allow all outbound traffic",
      },
    ],
    tags: {
      Name: `magazine-cms-${$app.stage}-lambda-sg`,
      Environment: $app.stage,
      ManagedBy: "SST",
    },
  });

  // ========================================
  // WAFÊßãÁØâ
  // ========================================
  const webAcl = new aws.wafv2.WebAcl("SiteWaf", {
    name: `magazine-cms-${$app.stage}-waf`,
    description: "WAF for Next.js site",
    scope: "CLOUDFRONT",
    defaultAction: {
      allow: {},
    },
    rules: [
      // Rate limiting
      {
        name: "RateLimit",
        priority: 1,
        action: {
          block: {},
        },
        statement: {
          rateBasedStatement: {
            limit: 2000,
            aggregateKeyType: "IP",
          },
        },
        visibilityConfig: {
          sampledRequestsEnabled: true,
          cloudwatchMetricsEnabled: true,
          metricName: "RateLimit",
        },
      },
      // AWS Managed Rules: Core Rule Set
      {
        name: "AWSManagedRulesCommonRuleSet",
        priority: 2,
        overrideAction: {
          none: {},
        },
        statement: {
          managedRuleGroupStatement: {
            vendorName: "AWS",
            name: "AWSManagedRulesCommonRuleSet",
          },
        },
        visibilityConfig: {
          sampledRequestsEnabled: true,
          cloudwatchMetricsEnabled: true,
          metricName: "AWSManagedRulesCommonRuleSet",
        },
      },
      // AWS Managed Rules: Known Bad Inputs
      {
        name: "AWSManagedRulesKnownBadInputsRuleSet",
        priority: 3,
        overrideAction: {
          none: {},
        },
        statement: {
          managedRuleGroupStatement: {
            vendorName: "AWS",
            name: "AWSManagedRulesKnownBadInputsRuleSet",
          },
        },
        visibilityConfig: {
          sampledRequestsEnabled: true,
          cloudwatchMetricsEnabled: true,
          metricName: "AWSManagedRulesKnownBadInputsRuleSet",
        },
      },
    ],
    visibilityConfig: {
      sampledRequestsEnabled: true,
      cloudwatchMetricsEnabled: true,
      metricName: `magazine-cms-${$app.stage}-waf`,
    },
    tags: {
      Environment: $app.stage,
      ManagedBy: "SST",
    },
  });

  // ========================================
  // Next.js„Çµ„Ç§„Éà
  // ========================================
  const site = new sst.aws.Nextjs("Site", {
    path: "./",

    // VPCÁµ±ÂêàÔºàLive LambdaÁî®Ôºâ
    vpc: {
      securityGroups: [lambdaSg.id],
      subnets: vpc.privateSubnets,
    },

    // Áí∞Â¢ÉÂ§âÊï∞
    environment: {
      NEXT_PUBLIC_STAGE: $app.stage,
      // Notion API KeyÔºàSST Secret„Åã„ÇâÊ≥®ÂÖ•Ôºâ
      NOTION_API_KEY: new sst.Secret("NotionApiKey").value,
      NOTION_INTEGRATION_TOKEN: new sst.Secret("NotionIntegrationToken").value,
    },

    // LambdaË®≠ÂÆö
    server: {
      memory: $app.stage === "prod" ? "2 GB" : "1 GB",
      timeout: "30 seconds",
      logging: {
        retention: $app.stage === "prod" ? "1 month" : "1 week",
      },
    },

    // CloudFrontË®≠ÂÆö
    transform: {
      cdn: {
        // WAFÈñ¢ÈÄ£‰ªò„Åë
        webAclId: webAcl.arn,

        // „Ç≠„É£„ÉÉ„Ç∑„É•Ë®≠ÂÆö
        defaultCacheBehavior: {
          compress: true,
        },

        // „Ç´„Çπ„Çø„É†„Éâ„É°„Ç§„É≥Ôºàprod „ÅÆ„ÅøÔºâ
        ...(($app.stage === "prod") && {
          aliases: ["magazine.example.com"],
          viewerCertificate: {
            acmCertificateArn: "<ACMË®ºÊòéÊõ∏ARN>",
            sslSupportMethod: "sni-only",
          },
        }),
      },
    },

    // „Çø„Ç∞
    tags: {
      Environment: $app.stage,
      Project: "magazine-cms",
      ManagedBy: "SST",
    },
  });

  // ========================================
  // CloudWatch Alarms
  // ========================================
  const errorAlarm = new aws.cloudwatch.MetricAlarm("LambdaErrorAlarm", {
    name: `magazine-cms-${$app.stage}-lambda-errors`,
    comparisonOperator: "GreaterThanThreshold",
    evaluationPeriods: 2,
    metricName: "Errors",
    namespace: "AWS/Lambda",
    period: 300,
    statistic: "Sum",
    threshold: 10,
    alarmDescription: "Lambda error rate is too high",
    dimensions: {
      FunctionName: site.nodes.server.name, // Next.js LambdaÈñ¢Êï∞Âêç
    },
    tags: {
      Environment: $app.stage,
      ManagedBy: "SST",
    },
  });

  // ========================================
  // Âá∫Âäõ
  // ========================================
  return {
    url: site.url,
    vpcId: vpc.id,
    wafAclArn: webAcl.arn,
  };
}
```

---

## ‰Ωø„ÅÑÊñπ

### ÂàùÂõû„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó

```bash
# 1. DevÁí∞Â¢É„ÅÆOIDC„É≠„Éº„É´„Çí„Éá„Éó„É≠„Ç§
npm run sso:dev
npm run deploy:oidc:dev

# Âá∫Âäõ‰æã:
# ‚úì Complete
#   roleArn: arn:aws:iam::123456789012:role/magazine-cms-github-actions-role
#   roleName: magazine-cms-github-actions-role

# 2. GitHub Secrets„Å´ÁôªÈå≤
gh secret set AWS_ROLE_ARN_DEV --body "arn:aws:iam::123456789012:role/magazine-cms-github-actions-role"
gh secret set AWS_REGION_DEV --body "ap-northeast-1"

# 3. Stg/ProdÁí∞Â¢É„ÇÇÂêåÊßò
npm run deploy:oidc:stg
npm run deploy:oidc:prod
```

### „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„Éá„Éó„É≠„Ç§

```bash
# Notion API„Ç≠„Éº„ÇíÁôªÈå≤ÔºàÂàùÂõû„ÅÆ„ÅøÔºâ
AWS_PROFILE=magazine-cms-dev sst secret set NotionApiKey <key> --stage dev
AWS_PROFILE=magazine-cms-dev sst secret set NotionIntegrationToken <token> --stage dev

# „Éá„Éó„É≠„Ç§
npm run deploy:dev
npm run deploy:stg
npm run deploy:prod
```

### ÈñãÁô∫„É¢„Éº„Éâ

```bash
# ÈÄöÂ∏∏ÈñãÁô∫
npm run dev  # ‚Üí http://localhost:3000

# Live LambdaÈñãÁô∫
npm run sso
npm run dev:sst
```

---

## „Éá„Éó„É≠„Ç§È†ÜÂ∫è

### ÂàùÂõû„Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÊôÇ

1. **ÂêÑÁí∞Â¢É„ÅßOIDCÂü∫Áõ§„Éá„Éó„É≠„Ç§**
   ```
   Dev account  ‚Üí sst deploy --stage github-oidc
   Stg account  ‚Üí sst deploy --stage github-oidc
   Prod account ‚Üí sst deploy --stage github-oidc
   ```

2. **GitHub SecretsË®≠ÂÆö**

3. **„Ç¢„Éó„É™„Éá„Éó„É≠„Ç§**
   ```
   sst deploy --stage dev
   sst deploy --stage stg
   sst deploy --stage prod
   ```

### ÈÄöÂ∏∏ÈÅãÁî®ÊôÇ

- OIDC„É≠„Éº„É´: Â§âÊõ¥„Åó„Å™„ÅÑÔºà„Åæ„Åü„ÅØ„É≠„Éº„Ç´„É´„Åã„ÇâÊâãÂãïÔºâ
- „Ç¢„Éó„É™: CI/CD„ÅßËá™Âãï„Éá„Éó„É≠„Ç§

---

## „Éà„É©„Éñ„É´„Ç∑„É•„Éº„ÉÜ„Ç£„É≥„Ç∞

### OIDCÂü∫Áõ§„ÅÆÊõ¥Êñ∞„ÅåÂøÖË¶Å„Å™Â†¥Âêà

```bash
# „É≠„Éº„Ç´„É´„Åã„ÇâÊâãÂãïÂÆüË°å
AWS_PROFILE=magazine-cms-dev sst deploy --stage github-oidc

# Ê®©ÈôêËøΩÂä†„Å™„Å©„ÅÆÂ§âÊõ¥„ÇíÂèçÊò†
```

### OIDCÂü∫Áõ§„ÅÆÂâäÈô§

```bash
# Ê≥®ÊÑè: „Ç¢„Éó„É™„ÅåÂãï‰Ωú„Åó„Å™„Åè„Å™„Çã
AWS_PROFILE=magazine-cms-dev sst remove --stage github-oidc
```

### „Çπ„ÉÜ„Éº„Ç∏Á¢∫Ë™ç

```bash
# ÂêÑ„Çπ„ÉÜ„Éº„Ç∏„ÅÆÁä∂ÊÖãÁ¢∫Ë™ç
sst console --stage github-oidc
sst console --stage dev
sst console --stage stg
sst console --stage prod
```

---

## „Åæ„Å®„ÇÅ

### ‚úÖ SST PulumiÂÆåÁµê„ÅÆ„É°„É™„ÉÉ„Éà

1. **TypeScriptÁµ±‰∏Ä**: ÂÖ®„Å¶„ÅÆ„Ç§„É≥„Éï„É©„ÅåTypeScript„ÅßÂÆöÁæ©
2. **ÂûãÂÆâÂÖ®**: „Ç®„Éá„Ç£„Çø„ÅÆË£úÂÆå„ÉªÂûã„ÉÅ„Çß„ÉÉ„ÇØ
3. **Áä∂ÊÖãÁÆ°ÁêÜÁµ±‰∏Ä**: SSTÁµåÁî±„ÅßPulumiÁä∂ÊÖãÁÆ°ÁêÜ
4. **„Çπ„ÉÜ„Éº„Ç∏ÂàÜÈõ¢**: `--stage github-oidc`„ÅßÂü∫Áõ§„Å®„Ç¢„Éó„É™„ÇíÂàÜÈõ¢
5. **ÊüîËªüÊÄß**: ÂøÖË¶Å„Å´Âøú„Åò„Å¶„É™„ÇΩ„Éº„ÇπËøΩÂä†„ÅåÂÆπÊòì

### ‚ö†Ô∏è Ê≥®ÊÑèÁÇπ

1. **ÂàùÂõû„Éá„Éó„É≠„Ç§**: ÂêÑÁí∞Â¢É„Åß„É≠„Éº„Ç´„É´„Åã„ÇâÊâãÂãïÂÆüË°åÂøÖÈ†à
2. **Âæ™Áí∞‰æùÂ≠òÂõûÈÅø**: OIDC„É≠„Éº„É´Â§âÊõ¥ÊôÇ„ÅØ„É≠„Éº„Ç´„É´„Åã„ÇâÂÆüË°å
3. **Â≠¶Áøí„Ç≥„Çπ„Éà**: Pulumi AWS„É™„ÇΩ„Éº„Çπ„ÅÆÊõ∏„ÅçÊñπ„ÇíÁøíÂæó

### üéØ Êé®Â•®ÈÅãÁî®„Éï„É≠„Éº

```
[ÂàùÂõû„ÅÆ„Åø]
1. sst deploy --stage github-oidc (ÂêÑAWS„Ç¢„Ç´„Ç¶„É≥„Éà)
2. GitHub SecretsË®≠ÂÆö

[Êó•Â∏∏ÈÅãÁî®]
3. git push ‚Üí GitHub Actions ‚Üí sst deploy --stage dev/stg/prod
4. OIDC„É≠„Éº„É´„ÅØÊªÖÂ§ö„Å´Â§âÊõ¥„Åó„Å™„ÅÑ

[OIDCÂ§âÊõ¥ÊôÇ]
5. „É≠„Éº„Ç´„É´„Åã„Çâ sst deploy --stage github-oidc
```

„Åì„ÅÆÊñπÂºè„Å™„Çâ„ÄÅÂÖ®„Å¶SST/Pulumi„ÅßÂÆåÁµê„Åó„Å™„Åå„Çâ„ÄÅÂü∫Áõ§„Å®„Ç¢„Éó„É™„ÅÆ„É©„Ç§„Éï„Çµ„Ç§„ÇØ„É´„ÇíÂàÜÈõ¢„Åß„Åç„Åæ„ÅôÔºÅ
